# Курс Яндекс.Практикума «Архитектура ПО»
## Практическое задание 2-го спринта

### 3. Шардирование с репликацией

Для запуска контейнеров следует перейти в терминале в данную директорию (mongo-sharding-repl) и выполнить следующую команду.

```bash
$ docker compose up -d
```

Затем для настройки кластера нужно последовательно выполнить первые 5 скриптов из директории scripts. Первым скриптом переводится в режим набор реплик (replica set) сервер, отвечающий за обслуживание БД конфигурации.

```bash
$ scripts/01-config-rs-init.sh
```

Вторым скриптом в режим набора реплик переводится сервер, выполняющий роль шарды № 1.

```bash
$ scripts/02-shard1-rs-init.sh
```

То же для шарды № 2.

```bash
$ scripts/03-shard2-rs-init.sh
```

Четвёртый скрипт добавляет обе наши шарды специальной командой на роутере.

```bash
$ scripts/04-add-shards.sh
```

Пятым скриптом, наконец, активируется шардирование для коллекции helloDoc.

```bash
$ scripts/05-shard-collection.sh
```

Шестой скрипт добавляет в коллекцию 1000 документов.

```bash
$ scripts/06-mongo-init.sh
```

Убедиться в том, что все поставленные цели были нами достигнуты, можно открыв в броузере следующий URL:

<http://localhost:8080/>

Вот тут нужно сказать честно, что, как я не пытался, мне не удалось подключить приложение *pymongo-api* к двум инстансам mongos одновременно.

* Прописывал в compose.yaml `MONGODB_URL: "mongodb://mongodb1,mongodb2"`
* И `MONGODB_URL: "mongodb://mongodb1:27017,mongodb2:27017/"`
* Обновлял версию motor до 3.6.0
* Подсовывал напрямую в приложении

```python
client = motor.motor_asyncio.AsyncIOMotorClient(['mongodb1:27017','mongodb2:27017'])
```

К сожалению, ничего не помогло.

Следующие 2 скрипта отобразят, как распределились между шардами вставленные 6-ым скриптом документы.

```bash
$ scripts/07-shard1-count.sh
```

```bash
$ scripts/08-shard2-count.sh
```

Остановить и удалить все контейнеры, а также почистить за ними созданные тома (volumes) призвана следующая команда:

```bash
$ docker compose down -v
```
